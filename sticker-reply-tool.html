<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>âš¡ è²¼åœ–å›è¦†ç”¢ç”Ÿå™¨</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Cubic+11&family=LXGW+WenKai+TC:wght@400;700&family=Zen+Maru+Gothic:wght@700;900&family=Kosugi+Maru&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: #0a0a0b;
      color: #e5e5e5;
      min-height: 100vh;
      padding: 16px;
      padding-bottom: 100px;
    }

    h1 {
      font-size: 24px;
      text-align: center;
      margin-bottom: 16px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* å€å¡Šæ¨™é¡Œ */
    .section-title {
      font-size: 14px;
      color: #71717a;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: #27272a;
    }

    /* è¼¸å…¥å€å¡Š */
    .input-section {
      background: #18181b;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    textarea {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      font-family: inherit;
      background: #27272a;
      border: 1px solid #3f3f46;
      border-radius: 8px;
      color: #e5e5e5;
      resize: none;
      margin-bottom: 12px;
    }
    textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .control-row {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .label {
      font-size: 14px;
      color: #a1a1aa;
      min-width: 50px;
    }

    .btn-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .option-btn {
      padding: 8px 14px;
      font-size: 14px;
      background: #27272a;
      border: 1px solid #3f3f46;
      border-radius: 6px;
      color: #a1a1aa;
      cursor: pointer;
      transition: all 0.2s;
    }
    .option-btn:hover { background: #3f3f46; }
    .option-btn.active {
      background: #667eea;
      border-color: #667eea;
      color: #fff;
    }

    input[type="range"] {
      flex: 1;
      height: 6px;
      -webkit-appearance: none;
      appearance: none;
      background: #3f3f46;
      border-radius: 3px;
      cursor: pointer;
      min-width: 100px;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      background: #667eea;
      border-radius: 50%;
      cursor: pointer;
    }

    .color-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .color-picker {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    input[type="color"] {
      width: 36px;
      height: 36px;
      padding: 0;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: transparent;
    }
    input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
    input[type="color"]::-webkit-color-swatch {
      border: 2px solid #3f3f46;
      border-radius: 6px;
    }

    /* å­—é«”é¸æ“‡ */
    .font-select {
      padding: 8px 12px;
      font-size: 14px;
      background: #27272a;
      border: 1px solid #3f3f46;
      border-radius: 6px;
      color: #e5e5e5;
      cursor: pointer;
      min-width: 140px;
    }
    .font-select:focus {
      outline: none;
      border-color: #667eea;
    }

    /* ä¸Šå‚³å€ */
    .upload-section {
      margin-bottom: 16px;
    }
    .upload-btn {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      font-family: inherit;
      background: transparent;
      border: 2px dashed #3f3f46;
      border-radius: 12px;
      color: #a1a1aa;
      cursor: pointer;
      transition: all 0.2s;
    }
    .upload-btn:hover {
      border-color: #667eea;
      color: #667eea;
    }
    #file-input { display: none; }

    /* è²¼åœ–ç¶²æ ¼ */
    .sticker-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      gap: 10px;
      margin-bottom: 16px;
    }

    .sticker-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      background: #27272a;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .sticker-item:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
    }
    .sticker-item:active {
      transform: scale(0.95);
    }

    .sticker-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .sticker-item .delete-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(239, 68, 68, 0.9);
      border: none;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }
    .sticker-item:hover .delete-btn { display: flex; }

    /* å…§å»ºåœ–ç‰‡ç®¡ç† */
    .manage-section {
      background: #18181b;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .manage-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .manage-title {
      font-size: 14px;
      color: #a1a1aa;
    }

    .manage-toggle {
      padding: 6px 12px;
      font-size: 12px;
      background: #27272a;
      border: 1px solid #3f3f46;
      border-radius: 6px;
      color: #a1a1aa;
      cursor: pointer;
    }
    .manage-toggle:hover { background: #3f3f46; }

    .manage-content {
      display: none;
    }
    .manage-content.show { display: block; }

    .add-builtin-btn {
      width: 100%;
      padding: 12px;
      font-size: 14px;
      font-family: inherit;
      background: #667eea;
      border: none;
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
      margin-bottom: 12px;
    }
    .add-builtin-btn:hover {
      background: #5a6fd6;
    }
    #builtin-file-input { display: none; }

    /* GitHub è¨­å®š */
    .github-section {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #3f3f46;
    }
    .github-input-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    .github-input {
      flex: 1;
      padding: 10px 12px;
      font-size: 13px;
      background: #27272a;
      border: 1px solid #3f3f46;
      border-radius: 6px;
      color: #e5e5e5;
    }
    .github-input:focus {
      outline: none;
      border-color: #667eea;
    }
    .github-btn {
      padding: 10px 14px;
      font-size: 13px;
      background: #27272a;
      border: 1px solid #3f3f46;
      border-radius: 6px;
      color: #a1a1aa;
      cursor: pointer;
    }
    .github-btn:hover { background: #3f3f46; }
    .github-btn.primary {
      background: #667eea;
      border-color: #667eea;
      color: #fff;
    }
    .github-hint {
      font-size: 12px;
      color: #71717a;
      margin-top: 4px;
    }
    .github-status {
      font-size: 12px;
      color: #10b981;
      margin-top: 8px;
    }
    .github-status.error { color: #ef4444; }

    .builtin-list {
      max-height: 200px;
      overflow-y: auto;
    }
    .builtin-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: #27272a;
      border-radius: 6px;
      margin-bottom: 6px;
    }
    .builtin-item img {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 4px;
    }
    .builtin-item .url-text {
      flex: 1;
      font-size: 12px;
      color: #71717a;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .builtin-item .remove-btn {
      padding: 4px 8px;
      font-size: 12px;
      background: #ef4444;
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
    }

    /* çµæœå½ˆçª— */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-overlay.show { display: flex; }

    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: #27272a;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-hint {
      color: #a1a1aa;
      font-size: 14px;
      margin-bottom: 16px;
      text-align: center;
    }
    .modal-hint strong {
      color: #667eea;
    }

    .result-image {
      max-width: 90%;
      max-height: 70vh;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      -webkit-touch-callout: default;
      -webkit-user-select: auto;
      user-select: auto;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .action-btn {
      padding: 14px 28px;
      font-size: 16px;
      font-family: inherit;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.2s;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
    }
    .action-btn:active { transform: scale(0.95); }

    /* ä½¿ç”¨èªªæ˜ */
    .instructions {
      text-align: center;
      color: #71717a;
      font-size: 14px;
      padding: 16px;
      border-top: 1px solid #27272a;
    }
    .instructions p { margin: 4px 0; }

    #canvas { display: none; }

    .empty-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 30px 20px;
      color: #71717a;
      font-size: 14px;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      background: #10b981;
      color: #fff;
      border-radius: 8px;
      font-weight: 600;
      z-index: 2000;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }
    .toast.show { opacity: 1; }
    .toast.error { background: #ef4444; }
  </style>
</head>
<body>
  <h1>âš¡ è²¼åœ–å›è¦†ç”¢ç”Ÿå™¨</h1>

  <!-- æ–‡å­—è¨­å®š -->
  <div class="input-section">
    <textarea id="text-input" placeholder="è¼¸å…¥è¦åŠ åœ¨è²¼åœ–ä¸Šçš„æ–‡å­—ï¼ˆç•™ç©ºå‰‡ä½¿ç”¨åŸåœ–ï¼‰" rows="2"></textarea>
    
    <div class="controls">
      <!-- ä½ç½® -->
      <div class="control-row">
        <span class="label">ä½ç½®</span>
        <div class="btn-group" id="position-btns">
          <button class="option-btn" data-pos="top">ä¸Šæ–¹</button>
          <button class="option-btn" data-pos="center">ä¸­å¤®</button>
          <button class="option-btn active" data-pos="bottom">ä¸‹æ–¹</button>
        </div>
      </div>

      <!-- å­—é«”å¤§å°ï¼ˆç™¾åˆ†æ¯”ï¼‰ -->
      <div class="control-row">
        <span class="label">å¤§å°</span>
        <input type="range" id="font-size" min="3" max="15" value="8" step="0.5">
        <span id="font-size-label">8%</span>
      </div>

      <!-- å­—é«”é¸æ“‡ -->
      <div class="control-row">
        <span class="label">å­—é«”</span>
        <select class="font-select" id="font-select">
          <option value="'Noto Sans TC', sans-serif" data-weight="900">æ€æºé»‘é«”</option>
          <option value="'LXGW WenKai TC', cursive" data-weight="700">éœé¶©æ–‡æ¥·</option>
          <option value="'Zen Maru Gothic', sans-serif" data-weight="900">Zen åœ“é«”</option>
          <option value="'Kosugi Maru', sans-serif" data-weight="400">å°æ‰åœ“é«”</option>
          <option value="'Cubic 11', monospace" data-weight="400">ä¿æ–¹é«”11</option>
        </select>
      </div>

      <!-- é¡è‰² -->
      <div class="color-controls">
        <div class="color-picker">
          <span class="label">æ–‡å­—</span>
          <input type="color" id="text-color" value="#ffffff">
        </div>
        <div class="color-picker">
          <span class="label">æé‚Š</span>
          <input type="color" id="stroke-color" value="#000000">
        </div>
        <button class="option-btn active" id="stroke-toggle">æé‚Š ON</button>
      </div>
    </div>
  </div>

  <!-- å…§å»ºåœ–ç‰‡ç®¡ç† -->
  <div class="manage-section">
    <div class="manage-header">
      <span class="manage-title">ğŸ“ å…§å»ºè²¼åœ–ç®¡ç†</span>
      <button class="manage-toggle" id="manage-toggle">å±•é–‹è¨­å®š</button>
    </div>
    <div class="manage-content" id="manage-content">
      <button class="add-builtin-btn" id="add-builtin-btn">+ ä¸Šå‚³åœ–ç‰‡è¨­ç‚ºå…§å»ºè²¼åœ–</button>
      <input type="file" id="builtin-file-input" accept="image/*" multiple>
      
      <!-- GitHub è¨­å®š -->
      <div class="github-section">
        <div class="github-input-row">
          <input type="text" class="github-input" id="github-input" placeholder="GitHub: ä½¿ç”¨è€…/å„²å­˜åº«/è³‡æ–™å¤¾">
          <button class="github-btn primary" id="github-load-btn">è¼‰å…¥</button>
          <button class="github-btn" id="github-save-btn">å„²å­˜è¨­å®š</button>
        </div>
        <p class="github-hint">ç¯„ä¾‹ï¼šhealer/stickers/imagesï¼ˆæœƒå¾æ­¤è³‡æ–™å¤¾è¼‰å…¥æ‰€æœ‰åœ–ç‰‡ï¼‰</p>
        <p class="github-status" id="github-status"></p>
      </div>
      
      <div class="builtin-list" id="builtin-list"></div>
    </div>
  </div>

  <!-- å…§å»ºè²¼åœ– -->
  <p class="section-title">ğŸ“Œ å…§å»ºè²¼åœ–</p>
  <div class="sticker-grid" id="builtin-grid">
    <div class="empty-state">å°šç„¡å…§å»ºè²¼åœ–ï¼Œè«‹åœ¨ä¸Šæ–¹ç®¡ç†å€æ–°å¢</div>
  </div>

  <!-- ä¸Šå‚³å€ -->
  <p class="section-title">ğŸ“¤ è‡¨æ™‚ä¸Šå‚³</p>
  <div class="upload-section">
    <button class="upload-btn" id="upload-btn">+ ä¸Šå‚³åœ–ç‰‡ï¼ˆä¸æœƒå„²å­˜ï¼‰</button>
    <input type="file" id="file-input" accept="image/*" multiple>
  </div>

  <!-- è‡¨æ™‚è²¼åœ– -->
  <div class="sticker-grid" id="temp-grid"></div>

  <!-- çµæœå½ˆçª— -->
  <div class="modal-overlay" id="modal">
    <button class="modal-close" id="modal-close">âœ•</button>
    <p class="modal-hint">ğŸ“± <strong>é•·æŒ‰åœ–ç‰‡</strong> å„²å­˜ ï½œ ğŸ–¥ï¸ <strong>å³éµè¤‡è£½</strong></p>
    <img class="result-image" id="result-image" src="" alt="åˆæˆçµæœ">
    <div class="modal-actions">
      <button class="action-btn" id="copy-btn">ğŸ“‹ è¤‡è£½åœ–ç‰‡</button>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- èªªæ˜ -->
  <div class="instructions">
    <p>ğŸ“ è¼¸å…¥æ–‡å­— â†’ é»æ“Šè²¼åœ– â†’ é•·æŒ‰ä¿å­˜ / å³éµè¤‡è£½</p>
  </div>

  <canvas id="canvas"></canvas>

  <script>
    // ========== é è¨­å…§å»ºåœ–ç‰‡ï¼ˆé¦–æ¬¡ä½¿ç”¨æ™‚è¼‰å…¥ï¼‰ ==========
    const DEFAULT_BUILTIN = [
      // åœ¨é€™è£¡æ”¾ä½ çš„é è¨­åœ–ç‰‡ URL
      // 'https://example.com/sticker1.png',
      // 'https://example.com/sticker2.png',
    ];

    // ========== é è¨­ GitHub è¨­å®š ==========
    // ğŸ‘‡ğŸ‘‡ğŸ‘‡ åœ¨é€™è£¡å¡«å…¥ä½ çš„ GitHub è·¯å¾‘ ğŸ‘‡ğŸ‘‡ğŸ‘‡
    const DEFAULT_GITHUB_REPO = 'YOUR_USERNAME/stickers';
    // æ ¼å¼ï¼šä½¿ç”¨è€…åç¨±/å„²å­˜åº«åç¨±
    // ç¯„ä¾‹ï¼šhealer123/my-stickers
    // å¦‚æœåœ–ç‰‡åœ¨å­è³‡æ–™å¤¾ï¼šhealer123/my-stickers/threads
    // â˜ï¸â˜ï¸â˜ï¸ ä¿®æ”¹ä¸Šé¢é€™è¡Œ â˜ï¸â˜ï¸â˜ï¸

    // ========== ç‹€æ…‹ ==========
    const state = {
      builtinUrls: [],      // å…§å»ºåœ–ç‰‡ URL åˆ—è¡¨ï¼ˆæœ¬æ©Ÿä¸Šå‚³ï¼‰
      githubUrls: [],       // GitHub åœ–ç‰‡ URL åˆ—è¡¨
      githubRepo: '',       // GitHub è·¯å¾‘è¨­å®š
      tempStickers: [],     // è‡¨æ™‚ä¸Šå‚³çš„åœ–ç‰‡
      textPosition: 'bottom',
      fontSizePercent: 8,   // æ”¹ç‚ºç™¾åˆ†æ¯”
      fontFamily: "'Noto Sans TC', sans-serif",
      fontWeight: '900',
      textColor: '#ffffff',
      strokeColor: '#000000',
      hasStroke: true,
      currentBlob: null,
      currentDataUrl: null
    };

    const POSITIONS = { top: 0.15, center: 0.5, bottom: 0.85 };

    // ========== DOM ==========
    const $ = id => document.getElementById(id);
    const el = {
      textInput: $('text-input'),
      fontSizeSlider: $('font-size'),
      fontSizeLabel: $('font-size-label'),
      fontSelect: $('font-select'),
      textColor: $('text-color'),
      strokeColor: $('stroke-color'),
      strokeToggle: $('stroke-toggle'),
      positionBtns: $('position-btns'),
      uploadBtn: $('upload-btn'),
      fileInput: $('file-input'),
      builtinGrid: $('builtin-grid'),
      tempGrid: $('temp-grid'),
      manageToggle: $('manage-toggle'),
      manageContent: $('manage-content'),
      addBuiltinBtn: $('add-builtin-btn'),
      builtinFileInput: $('builtin-file-input'),
      githubInput: $('github-input'),
      githubLoadBtn: $('github-load-btn'),
      githubSaveBtn: $('github-save-btn'),
      githubStatus: $('github-status'),
      builtinList: $('builtin-list'),
      modal: $('modal'),
      modalClose: $('modal-close'),
      resultImage: $('result-image'),
      copyBtn: $('copy-btn'),
      toast: $('toast'),
      canvas: $('canvas')
    };

    // ========== Toast ==========
    function showToast(msg, isError = false) {
      el.toast.textContent = msg;
      el.toast.className = 'toast show' + (isError ? ' error' : '');
      setTimeout(() => el.toast.className = 'toast', 2500);
    }

    // ========== æ–‡å­—æ›è¡Œ ==========
    function wrapText(ctx, text, maxWidth) {
      const lines = [];
      let currentLine = '';
      for (const char of text) {
        const testLine = currentLine + char;
        if (ctx.measureText(testLine).width > maxWidth && currentLine) {
          lines.push(currentLine);
          currentLine = char;
        } else {
          currentLine = testLine;
        }
      }
      if (currentLine) lines.push(currentLine);
      return lines;
    }

    // ========== åˆæˆåœ–ç‰‡ ==========
    async function processSticker(stickerUrl) {
      const canvas = el.canvas;
      const ctx = canvas.getContext('2d');
      const text = el.textInput.value.trim();

      const img = new Image();
      img.crossOrigin = 'anonymous';
      
      try {
        await new Promise((resolve, reject) => {
          img.onload = resolve;
          img.onerror = reject;
          img.src = stickerUrl;
        });
      } catch (e) {
        showToast('åœ–ç‰‡è¼‰å…¥å¤±æ•—', true);
        return;
      }

      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);

      if (text) {
        const posY = canvas.height * POSITIONS[state.textPosition];
        
        // å­—é«”å¤§å° = åœ–ç‰‡é«˜åº¦ Ã— ç™¾åˆ†æ¯”
        const fontSize = Math.round(canvas.height * (state.fontSizePercent / 100));
        
        ctx.font = `${state.fontWeight} ${fontSize}px ${state.fontFamily}`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        const maxWidth = canvas.width * 0.9;
        const lines = wrapText(ctx, text, maxWidth);
        const lineHeight = fontSize * 1.3;
        const startY = posY - ((lines.length - 1) * lineHeight) / 2;

        lines.forEach((line, i) => {
          const y = startY + i * lineHeight;
          if (state.hasStroke) {
            ctx.strokeStyle = state.strokeColor;
            ctx.lineWidth = fontSize / 8;
            ctx.lineJoin = 'round';
            ctx.strokeText(line, canvas.width / 2, y);
          }
          ctx.fillStyle = state.textColor;
          ctx.fillText(line, canvas.width / 2, y);
        });
      }

      state.currentDataUrl = canvas.toDataURL('image/png');
      state.currentBlob = await new Promise(r => canvas.toBlob(r, 'image/png'));

      el.resultImage.src = state.currentDataUrl;
      el.modal.classList.add('show');
    }

    // ========== è¤‡è£½ ==========
    async function tryCopy() {
      try {
        await navigator.clipboard.write([
          new ClipboardItem({ 'image/png': state.currentBlob })
        ]);
        showToast('âœ“ å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
      } catch (err) {
        showToast('è«‹é•·æŒ‰åœ–ç‰‡ä¿å­˜', true);
      }
    }

    // ========== æ¸²æŸ“å…§å»ºè²¼åœ–ç¶²æ ¼ ==========
    function renderBuiltinGrid() {
      // åˆä½µ GitHub å’Œæœ¬æ©Ÿä¸Šå‚³çš„åœ–ç‰‡
      const allUrls = [...state.githubUrls, ...state.builtinUrls];
      
      if (allUrls.length === 0) {
        el.builtinGrid.innerHTML = '<div class="empty-state">å°šç„¡å…§å»ºè²¼åœ–ï¼Œè«‹è¨­å®š GitHub æˆ–ä¸Šå‚³åœ–ç‰‡</div>';
        return;
      }

      el.builtinGrid.innerHTML = allUrls.map((url, idx) => `
        <div class="sticker-item" data-url="${url}">
          <img src="${url}" alt="è²¼åœ–${idx + 1}" loading="lazy">
        </div>
      `).join('');

      el.builtinGrid.querySelectorAll('.sticker-item').forEach(item => {
        item.addEventListener('click', () => processSticker(item.dataset.url));
      });
    }

    // ========== æ¸²æŸ“ç®¡ç†åˆ—è¡¨ ==========
    function renderBuiltinList() {
      if (state.builtinUrls.length === 0) {
        el.builtinList.innerHTML = '<div class="empty-state">å°šç„¡å…§å»ºè²¼åœ–</div>';
        return;
      }

      el.builtinList.innerHTML = state.builtinUrls.map((url, idx) => `
        <div class="builtin-item">
          <img src="${url}" alt="">
          <span class="url-text">è²¼åœ– ${idx + 1}</span>
          <button class="remove-btn" data-idx="${idx}">åˆªé™¤</button>
        </div>
      `).join('');

      el.builtinList.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.idx);
          state.builtinUrls.splice(idx, 1);
          saveBuiltinUrls();
          renderBuiltinGrid();
          renderBuiltinList();
          showToast('å·²åˆªé™¤');
        });
      });
    }

    // ========== æ¸²æŸ“è‡¨æ™‚è²¼åœ– ==========
    function renderTempGrid() {
      if (state.tempStickers.length === 0) {
        el.tempGrid.innerHTML = '';
        return;
      }

      el.tempGrid.innerHTML = state.tempStickers.map((s, idx) => `
        <div class="sticker-item" data-url="${s.url}" data-idx="${idx}">
          <img src="${s.url}" alt="${s.name}">
          <button class="delete-btn" data-idx="${idx}">âœ•</button>
        </div>
      `).join('');

      el.tempGrid.querySelectorAll('.sticker-item').forEach(item => {
        item.addEventListener('click', e => {
          if (e.target.classList.contains('delete-btn')) return;
          processSticker(item.dataset.url);
        });
      });

      el.tempGrid.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', e => {
          e.stopPropagation();
          const idx = parseInt(btn.dataset.idx);
          state.tempStickers.splice(idx, 1);
          renderTempGrid();
        });
      });
    }

    // ========== å„²å­˜/è®€å– ==========
    function saveBuiltinUrls() {
      try {
        localStorage.setItem('sticker-builtin-urls', JSON.stringify(state.builtinUrls));
      } catch (e) {
        // localStorage å¯èƒ½è¶…å‡ºå®¹é‡ï¼ˆç´„ 5MBï¼‰
        showToast('å„²å­˜ç©ºé–“å·²æ»¿ï¼Œè«‹åˆªé™¤ä¸€äº›è²¼åœ–', true);
        // ç§»é™¤å‰›åŠ å…¥çš„é‚£å¼µ
        state.builtinUrls.shift();
      }
    }

    function loadBuiltinUrls() {
      try {
        const saved = localStorage.getItem('sticker-builtin-urls');
        if (saved) {
          state.builtinUrls = JSON.parse(saved);
        } else if (DEFAULT_BUILTIN.length > 0) {
          // é¦–æ¬¡ä½¿ç”¨ï¼Œè¼‰å…¥é è¨­
          state.builtinUrls = [...DEFAULT_BUILTIN];
          saveBuiltinUrls();
        }
      } catch (e) {
        state.builtinUrls = [...DEFAULT_BUILTIN];
      }
    }

    // ========== GitHub è¼‰å…¥åŠŸèƒ½ ==========
    async function loadFromGitHub(repoPath) {
      if (!repoPath.trim()) {
        el.githubStatus.textContent = 'è«‹è¼¸å…¥ GitHub è·¯å¾‘';
        el.githubStatus.className = 'github-status error';
        return;
      }

      el.githubStatus.textContent = 'è¼‰å…¥ä¸­...';
      el.githubStatus.className = 'github-status';

      try {
        // è§£æè·¯å¾‘: user/repo/folder
        const parts = repoPath.trim().split('/');
        if (parts.length < 2) {
          throw new Error('æ ¼å¼éŒ¯èª¤ï¼Œè«‹ä½¿ç”¨: ä½¿ç”¨è€…/å„²å­˜åº«/è³‡æ–™å¤¾');
        }

        const user = parts[0];
        const repo = parts[1];
        const folder = parts.slice(2).join('/') || '';

        // ä½¿ç”¨ GitHub API å–å¾—æª”æ¡ˆåˆ—è¡¨
        const apiUrl = `https://api.github.com/repos/${user}/${repo}/contents/${folder}`;
        const response = await fetch(apiUrl);
        
        if (!response.ok) {
          throw new Error('æ‰¾ä¸åˆ°æ­¤å„²å­˜åº«æˆ–è³‡æ–™å¤¾');
        }

        const files = await response.json();
        
        // ç¯©é¸åœ–ç‰‡æª”æ¡ˆ
        const imageFiles = files.filter(f => 
          f.type === 'file' && 
          /\.(jpg|jpeg|png|gif|webp)$/i.test(f.name)
        );

        if (imageFiles.length === 0) {
          throw new Error('æ­¤è³‡æ–™å¤¾ä¸­æ²’æœ‰åœ–ç‰‡æª”æ¡ˆ');
        }

        // è½‰æ›ç‚º raw URL
        state.githubUrls = imageFiles.map(f => 
          `https://raw.githubusercontent.com/${user}/${repo}/main/${folder ? folder + '/' : ''}${f.name}`
        );

        el.githubStatus.textContent = `âœ“ å·²è¼‰å…¥ ${state.githubUrls.length} å¼µåœ–ç‰‡`;
        el.githubStatus.className = 'github-status';
        
        renderBuiltinGrid();

      } catch (err) {
        el.githubStatus.textContent = 'âœ— ' + err.message;
        el.githubStatus.className = 'github-status error';
      }
    }

    function saveGitHubConfig() {
      state.githubRepo = el.githubInput.value.trim();
      localStorage.setItem('sticker-github-repo', state.githubRepo);
      showToast('âœ“ GitHub è¨­å®šå·²å„²å­˜');
    }

    function loadGitHubConfig() {
      // å„ªå…ˆä½¿ç”¨ç¨‹å¼ç¢¼ä¸­çš„é è¨­å€¼
      if (DEFAULT_GITHUB_REPO && DEFAULT_GITHUB_REPO !== 'YOUR_USERNAME/stickers') {
        state.githubRepo = DEFAULT_GITHUB_REPO;
        el.githubInput.value = DEFAULT_GITHUB_REPO;
        loadFromGitHub(DEFAULT_GITHUB_REPO);
        return;
      }
      
      // å¦å‰‡ä½¿ç”¨ localStorage å„²å­˜çš„è¨­å®š
      const saved = localStorage.getItem('sticker-github-repo');
      if (saved) {
        state.githubRepo = saved;
        el.githubInput.value = saved;
        loadFromGitHub(saved);
      }
    }

    // ========== æ–°å¢å…§å»ºåœ–ç‰‡ï¼ˆå¾æª”æ¡ˆï¼‰ ==========
    function addBuiltinFiles(files) {
      Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = ev => {
          const base64 = ev.target.result;
          
          // ç”¨ base64 é•·åº¦ + çµå°¾ 50 å­—å…ƒä½œç‚ºç°¡æ˜“æŒ‡ç´‹
          const fingerprint = base64.length + '_' + base64.slice(-50);
          const isDuplicate = state.builtinUrls.some(url => {
            const fp = url.length + '_' + url.slice(-50);
            return fp === fingerprint;
          });
          
          if (isDuplicate) {
            showToast('æ­¤åœ–ç‰‡å·²å­˜åœ¨', true);
            return;
          }

          state.builtinUrls.unshift(base64);
          saveBuiltinUrls();
          renderBuiltinGrid();
          renderBuiltinList();
          showToast('âœ“ å·²æ–°å¢');
        };
        reader.readAsDataURL(file);
      });
    }

    // ========== äº‹ä»¶ç¶å®š ==========
    function initEvents() {
      // ä½ç½®
      el.positionBtns.addEventListener('click', e => {
        if (!e.target.dataset.pos) return;
        document.querySelectorAll('#position-btns .option-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.pos === e.target.dataset.pos);
        });
        state.textPosition = e.target.dataset.pos;
      });

      // å­—é«”å¤§å°ï¼ˆç™¾åˆ†æ¯”ï¼‰
      el.fontSizeSlider.addEventListener('input', e => {
        state.fontSizePercent = parseFloat(e.target.value);
        el.fontSizeLabel.textContent = state.fontSizePercent + '%';
      });

      // å­—é«”é¸æ“‡
      el.fontSelect.addEventListener('change', e => {
        const selected = e.target.options[e.target.selectedIndex];
        state.fontFamily = e.target.value;
        state.fontWeight = selected.dataset.weight || '700';
      });

      // é¡è‰²
      el.textColor.addEventListener('input', e => state.textColor = e.target.value);
      el.strokeColor.addEventListener('input', e => state.strokeColor = e.target.value);

      // æé‚Š
      el.strokeToggle.addEventListener('click', () => {
        state.hasStroke = !state.hasStroke;
        el.strokeToggle.textContent = `æé‚Š ${state.hasStroke ? 'ON' : 'OFF'}`;
        el.strokeToggle.classList.toggle('active', state.hasStroke);
      });

      // ç®¡ç†å€å±•é–‹/æ”¶åˆ
      el.manageToggle.addEventListener('click', () => {
        const isShow = el.manageContent.classList.toggle('show');
        el.manageToggle.textContent = isShow ? 'æ”¶åˆè¨­å®š' : 'å±•é–‹è¨­å®š';
      });

      // æ–°å¢å…§å»ºåœ–ç‰‡ï¼ˆæª”æ¡ˆä¸Šå‚³ï¼‰
      el.addBuiltinBtn.addEventListener('click', () => el.builtinFileInput.click());
      el.builtinFileInput.addEventListener('change', e => {
        if (e.target.files.length > 0) {
          addBuiltinFiles(e.target.files);
          e.target.value = '';
        }
      });

      // GitHub è¼‰å…¥
      el.githubLoadBtn.addEventListener('click', () => loadFromGitHub(el.githubInput.value));
      el.githubSaveBtn.addEventListener('click', saveGitHubConfig);
      el.githubInput.addEventListener('keypress', e => {
        if (e.key === 'Enter') loadFromGitHub(el.githubInput.value);
      });

      // ä¸Šå‚³è‡¨æ™‚åœ–ç‰‡
      el.uploadBtn.addEventListener('click', () => el.fileInput.click());
      el.fileInput.addEventListener('change', e => {
        Array.from(e.target.files).forEach(file => {
          const reader = new FileReader();
          reader.onload = ev => {
            state.tempStickers.unshift({
              url: ev.target.result,
              name: file.name
            });
            renderTempGrid();
          };
          reader.readAsDataURL(file);
        });
        e.target.value = '';
      });

      // å½ˆçª—
      el.modalClose.addEventListener('click', () => el.modal.classList.remove('show'));
      el.modal.addEventListener('click', e => {
        if (e.target === el.modal) el.modal.classList.remove('show');
      });

      // è¤‡è£½
      el.copyBtn.addEventListener('click', tryCopy);
    }

    // ========== åˆå§‹åŒ– ==========
    loadBuiltinUrls();
    loadGitHubConfig();
    renderBuiltinGrid();
    renderBuiltinList();
    renderTempGrid();
    initEvents();
  </script>
</body>
</html>
